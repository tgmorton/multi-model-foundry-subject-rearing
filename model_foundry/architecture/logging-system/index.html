
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Complete documentation for the Model Foundry training framework and analysis tools">
      
      
        <meta name="author" content="Model Foundry Team">
      
      
        <link rel="canonical" href="https://tgmorton.github.io/multi-model-foundry-subject-rearing/model_foundry/architecture/logging-system/">
      
      
        <link rel="prev" href="../multi-architecture-system/">
      
      
        <link rel="next" href="../training-refactoring/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Logging System - Model Foundry Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#model-foundry-logging-system-comprehensive-plan" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Model Foundry Documentation" class="md-header__button md-logo" aria-label="Model Foundry Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Model Foundry Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Logging System
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tgmorton/multi-model-foundry-subject-rearing" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tgmorton/multi-model-foundry-subject-rearing
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../STRUCTURE/" class="md-tabs__link">
        
  
  
    
  
  Project Structure

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../TRAINING_GUIDE/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../checkpoint_scheduling/" class="md-tabs__link">
          
  
  
  Experiments

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  Model Foundry

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../preprocessing/USER_GUIDE/" class="md-tabs__link">
          
  
  
  Preprocessing

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Model Foundry Documentation" class="md-nav__button md-logo" aria-label="Model Foundry Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Model Foundry Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tgmorton/multi-model-foundry-subject-rearing" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tgmorton/multi-model-foundry-subject-rearing
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../STRUCTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project Structure
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../TRAINING_GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../TRAINING_ON_SLURM/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training on SLURM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../TRAINING_ON_WILD_WEST/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training on Wild West
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Processing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Experiments
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Experiments
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../checkpoint_scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Checkpoint Scheduling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../new_checkpoint_scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    New Checkpoint Scheduling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../phase3_experimental_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phase 3 Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CROSS_ARCHITECTURE_COMPARISON/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cross Architecture Comparison
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Model Foundry
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Model Foundry
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-architecture-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Architecture System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Logging System
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Logging System
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#executive-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Executive Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#current-state-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Current State Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Current State Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#existing-logging-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Existing Logging Infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#current-usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Current Usage Patterns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposed-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Proposed Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposed Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-logger-hierarchy" class="md-nav__link">
    <span class="md-ellipsis">
      1. Logger Hierarchy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-log-levels-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      2. Log Levels Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-structured-logging-format" class="md-nav__link">
    <span class="md-ellipsis">
      3. Structured Logging Format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-new-logging-components" class="md-nav__link">
    <span class="md-ellipsis">
      4. New Logging Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. New Logging Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-structuredlogger-class" class="md-nav__link">
    <span class="md-ellipsis">
      A. StructuredLogger Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-metricslogger-class" class="md-nav__link">
    <span class="md-ellipsis">
      B. MetricsLogger Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-performancelogger-class" class="md-nav__link">
    <span class="md-ellipsis">
      C. PerformanceLogger Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-errortracker-class" class="md-nav__link">
    <span class="md-ellipsis">
      D. ErrorTracker Class
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      5. Integration Points
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Integration Points">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-replace-print-in-datapy" class="md-nav__link">
    <span class="md-ellipsis">
      A. Replace print() in data.py
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-enhanced-training-loop-logging" class="md-nav__link">
    <span class="md-ellipsis">
      B. Enhanced Training Loop Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-checkpoint-saveload-logging" class="md-nav__link">
    <span class="md-ellipsis">
      C. Checkpoint Save/Load Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      6. Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-log-file-organization" class="md-nav__link">
    <span class="md-ellipsis">
      7. Log File Organization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-monitoring-integration" class="md-nav__link">
    <span class="md-ellipsis">
      8. Monitoring Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Monitoring Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wandb-integration" class="md-nav__link">
    <span class="md-ellipsis">
      WandB Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      9. Testing Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-core-infrastructure-week-1" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Core Infrastructure (Week 1)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-integration-week-2" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Integration (Week 2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-advanced-features-week-3" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Advanced Features (Week 3)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-documentation-polish-week-4" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Documentation &amp; Polish (Week 4)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migration Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#for-developers" class="md-nav__link">
    <span class="md-ellipsis">
      For Developers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-tests-comprehensive-test-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Unit Tests - Comprehensive Test Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Unit Tests - Comprehensive Test Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-file-testsunittest_loggingpy" class="md-nav__link">
    <span class="md-ellipsis">
      Test File: tests/unit/test_logging.py
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test File: tests/unit/test_logging.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-structuredlogger-tests-15-tests" class="md-nav__link">
    <span class="md-ellipsis">
      1. StructuredLogger Tests (15 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-metricslogger-tests-12-tests" class="md-nav__link">
    <span class="md-ellipsis">
      2. MetricsLogger Tests (12 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-performancelogger-tests-10-tests" class="md-nav__link">
    <span class="md-ellipsis">
      3. PerformanceLogger Tests (10 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-errortracker-tests-8-tests" class="md-nav__link">
    <span class="md-ellipsis">
      4. ErrorTracker Tests (8 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-loggingconfig-tests-5-tests" class="md-nav__link">
    <span class="md-ellipsis">
      5. LoggingConfig Tests (5 tests)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-file-testsintegrationtest_logging_integrationpy" class="md-nav__link">
    <span class="md-ellipsis">
      Test File: tests/integration/test_logging_integration.py
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#success-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      Success Criteria
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Success Criteria">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#functional-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Functional Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quality-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Quality Requirements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-log-message-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix: Log Message Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix: Log Message Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Startup Logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#training-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Training Logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Error Logs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#weights-biases-wandb-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Weights &amp; Biases (WandB) Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Weights &amp; Biases (WandB) Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-setup-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Setup Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-create-wandb-account" class="md-nav__link">
    <span class="md-ellipsis">
      1. Create WandB Account
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-configure-api-key" class="md-nav__link">
    <span class="md-ellipsis">
      2. Configure API Key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-enable-in-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      3. Enable in Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-run-training" class="md-nav__link">
    <span class="md-ellipsis">
      4. Run Training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-gets-logged-to-wandb" class="md-nav__link">
    <span class="md-ellipsis">
      What Gets Logged to WandB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wandblogger-usage" class="md-nav__link">
    <span class="md-ellipsis">
      WandBLogger Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viewing-results" class="md-nav__link">
    <span class="md-ellipsis">
      Viewing Results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../training-refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training Refactoring
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../refactoring-status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Refactoring Status
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/running-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/logging-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging Tests
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/wandb-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WandB Integration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Preprocessing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Preprocessing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../preprocessing/USER_GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../preprocessing/ADVANCED_USAGE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Usage
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#executive-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Executive Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#current-state-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Current State Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Current State Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#existing-logging-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Existing Logging Infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#current-usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Current Usage Patterns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposed-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Proposed Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposed Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-logger-hierarchy" class="md-nav__link">
    <span class="md-ellipsis">
      1. Logger Hierarchy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-log-levels-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      2. Log Levels Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-structured-logging-format" class="md-nav__link">
    <span class="md-ellipsis">
      3. Structured Logging Format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-new-logging-components" class="md-nav__link">
    <span class="md-ellipsis">
      4. New Logging Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. New Logging Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-structuredlogger-class" class="md-nav__link">
    <span class="md-ellipsis">
      A. StructuredLogger Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-metricslogger-class" class="md-nav__link">
    <span class="md-ellipsis">
      B. MetricsLogger Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-performancelogger-class" class="md-nav__link">
    <span class="md-ellipsis">
      C. PerformanceLogger Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-errortracker-class" class="md-nav__link">
    <span class="md-ellipsis">
      D. ErrorTracker Class
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      5. Integration Points
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Integration Points">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-replace-print-in-datapy" class="md-nav__link">
    <span class="md-ellipsis">
      A. Replace print() in data.py
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-enhanced-training-loop-logging" class="md-nav__link">
    <span class="md-ellipsis">
      B. Enhanced Training Loop Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-checkpoint-saveload-logging" class="md-nav__link">
    <span class="md-ellipsis">
      C. Checkpoint Save/Load Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      6. Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-log-file-organization" class="md-nav__link">
    <span class="md-ellipsis">
      7. Log File Organization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-monitoring-integration" class="md-nav__link">
    <span class="md-ellipsis">
      8. Monitoring Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Monitoring Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wandb-integration" class="md-nav__link">
    <span class="md-ellipsis">
      WandB Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      9. Testing Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-core-infrastructure-week-1" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Core Infrastructure (Week 1)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-integration-week-2" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Integration (Week 2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-advanced-features-week-3" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Advanced Features (Week 3)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-documentation-polish-week-4" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Documentation &amp; Polish (Week 4)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migration Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#for-developers" class="md-nav__link">
    <span class="md-ellipsis">
      For Developers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-tests-comprehensive-test-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Unit Tests - Comprehensive Test Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Unit Tests - Comprehensive Test Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-file-testsunittest_loggingpy" class="md-nav__link">
    <span class="md-ellipsis">
      Test File: tests/unit/test_logging.py
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test File: tests/unit/test_logging.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-structuredlogger-tests-15-tests" class="md-nav__link">
    <span class="md-ellipsis">
      1. StructuredLogger Tests (15 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-metricslogger-tests-12-tests" class="md-nav__link">
    <span class="md-ellipsis">
      2. MetricsLogger Tests (12 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-performancelogger-tests-10-tests" class="md-nav__link">
    <span class="md-ellipsis">
      3. PerformanceLogger Tests (10 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-errortracker-tests-8-tests" class="md-nav__link">
    <span class="md-ellipsis">
      4. ErrorTracker Tests (8 tests)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-loggingconfig-tests-5-tests" class="md-nav__link">
    <span class="md-ellipsis">
      5. LoggingConfig Tests (5 tests)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-file-testsintegrationtest_logging_integrationpy" class="md-nav__link">
    <span class="md-ellipsis">
      Test File: tests/integration/test_logging_integration.py
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#success-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      Success Criteria
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Success Criteria">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#functional-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Functional Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quality-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Quality Requirements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-log-message-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix: Log Message Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix: Log Message Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Startup Logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#training-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Training Logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Error Logs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#weights-biases-wandb-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Weights &amp; Biases (WandB) Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Weights &amp; Biases (WandB) Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-setup-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Setup Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-create-wandb-account" class="md-nav__link">
    <span class="md-ellipsis">
      1. Create WandB Account
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-configure-api-key" class="md-nav__link">
    <span class="md-ellipsis">
      2. Configure API Key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-enable-in-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      3. Enable in Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-run-training" class="md-nav__link">
    <span class="md-ellipsis">
      4. Run Training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-gets-logged-to-wandb" class="md-nav__link">
    <span class="md-ellipsis">
      What Gets Logged to WandB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wandblogger-usage" class="md-nav__link">
    <span class="md-ellipsis">
      WandBLogger Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viewing-results" class="md-nav__link">
    <span class="md-ellipsis">
      Viewing Results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="model-foundry-logging-system-comprehensive-plan">Model Foundry Logging System - Comprehensive Plan<a class="headerlink" href="#model-foundry-logging-system-comprehensive-plan" title="Permanent link">&para;</a></h1>
<h2 id="executive-summary">Executive Summary<a class="headerlink" href="#executive-summary" title="Permanent link">&para;</a></h2>
<p>This document outlines a complete logging architecture for the model_foundry training framework. The current implementation has basic logging utilities but inconsistent usage (mixing <code>print()</code> statements with logging), no structured logging, and limited observability for debugging production issues.</p>
<p><strong>Goals:</strong>
1. Replace all <code>print()</code> statements with proper logging
2. Implement structured logging with consistent message formats
3. Add log levels appropriate to message importance
4. Create dedicated loggers for different subsystems
5. Enable filtering, searching, and analysis of logs
6. Support integration with monitoring tools (WandB, TensorBoard)
7. Ensure thread-safe and multiprocessing-safe logging
8. Provide comprehensive unit tests for all logging functionality</p>
<hr />
<h2 id="current-state-analysis">Current State Analysis<a class="headerlink" href="#current-state-analysis" title="Permanent link">&para;</a></h2>
<h3 id="existing-logging-infrastructure">Existing Logging Infrastructure<a class="headerlink" href="#existing-logging-infrastructure" title="Permanent link">&para;</a></h3>
<p><strong>File: <code>logging_utils.py</code></strong> (248 lines)
- <code>setup_logging()</code> - Basic logger with file + console handlers
- <code>setup_experiment_logging()</code> - Experiment-specific logging
- <code>setup_multi_logging()</code> - Multiple loggers (main, errors, ablation, progress)
- <code>get_latest_log()</code> - Retrieve most recent log file
- <code>list_experiment_logs()</code> - List experiment logs
- <code>cleanup_empty_logs()</code> - Remove empty log files</p>
<p><strong>Strengths:</strong>
- Good foundation with file rotation by timestamp
- Experiment-scoped log directories
- Multiple logger support for different streams
- Utility functions for log management</p>
<p><strong>Weaknesses:</strong>
1. <strong>Inconsistent Usage</strong>: 30+ <code>print()</code> statements in <code>data.py</code> alone
2. <strong>No Structured Logging</strong>: All messages are plain text, hard to parse
3. <strong>No Context Information</strong>: Missing important metadata (step, epoch, git hash)
4. <strong>Duplicate Handler Issue</strong>: <code>_LOGGERS_CREATED</code> set only works within single process
5. <strong>No Log Levels Strategy</strong>: No clear guidelines on when to use DEBUG/INFO/WARNING/ERROR
6. <strong>No Metrics Logging</strong>: Training metrics scattered across console output
7. <strong>No Error Tracking</strong>: Exceptions not consistently logged with context
8. <strong>No Performance Logging</strong>: No timing information for bottleneck analysis</p>
<h3 id="current-usage-patterns">Current Usage Patterns<a class="headerlink" href="#current-usage-patterns" title="Permanent link">&para;</a></h3>
<p><strong>Files with <code>print()</code> statements:</strong>
- <code>data.py</code> (30+ statements) - Data validation, preprocessing progress
- <code>training/loop.py</code> - Training progress (though uses logger elsewhere)
- <code>training/checkpointing.py</code> - Checkpoint save/load
- <code>training/tokenization.py</code> - Tokenizer loading
- <code>model.py</code> - Model creation
- <code>utils.py</code> - General utilities
- <code>cli.py</code> - Command-line interface</p>
<p><strong>Files with proper logging:</strong>
- <code>trainer.py</code> - Uses <code>setup_logging()</code>
- <code>training/loop.py</code> - Has logger instance, uses it for some messages
- <code>training/checkpointing.py</code> - Has logger setup
- <code>cli.py</code> - Mix of logging and print</p>
<hr />
<h2 id="proposed-architecture">Proposed Architecture<a class="headerlink" href="#proposed-architecture" title="Permanent link">&para;</a></h2>
<h3 id="1-logger-hierarchy">1. Logger Hierarchy<a class="headerlink" href="#1-logger-hierarchy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>model_foundry (root)
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a> model_foundry.trainer         # Main orchestration
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a> model_foundry.data            # Data processing
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    validation                # Data validation
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    chunking                  # Chunking operations
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    loading                   # DataLoader operations
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a> model_foundry.model           # Model creation
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a> model_foundry.training        # Training subsystem
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    loop                      # Training loop
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    checkpointing             # Checkpoint management
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    tokenization              # Tokenizer operations
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a> model_foundry.metrics         # Metrics tracking
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    loss                      # Loss values
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    performance               # Speed, throughput
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    memory                    # Memory usage
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a> model_foundry.system          # System-level events
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>     errors                    # Error tracking
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>     warnings                  # Warning tracking
</code></pre></div>
<h3 id="2-log-levels-strategy">2. Log Levels Strategy<a class="headerlink" href="#2-log-levels-strategy" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Level</th>
<th>Usage</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DEBUG</strong></td>
<td>Detailed diagnostic info, variable values, loop iterations</td>
<td>"Processing chunk 45/1000", "Gradient norm: 2.34"</td>
</tr>
<tr>
<td><strong>INFO</strong></td>
<td>General progress, milestones, configuration</td>
<td>"Starting epoch 3/10", "Loaded model with 124M parameters"</td>
</tr>
<tr>
<td><strong>WARNING</strong></td>
<td>Unexpected but recoverable situations</td>
<td>"Using CPU (CUDA unavailable)", "Checkpoint file size unusually large"</td>
</tr>
<tr>
<td><strong>ERROR</strong></td>
<td>Errors that may impact results but don't stop execution</td>
<td>"Failed to save intermediate checkpoint", "NaN detected in gradients"</td>
</tr>
<tr>
<td><strong>CRITICAL</strong></td>
<td>Fatal errors requiring immediate attention</td>
<td>"Out of memory error", "Corrupted checkpoint - cannot resume"</td>
</tr>
</tbody>
</table>
<h3 id="3-structured-logging-format">3. Structured Logging Format<a class="headerlink" href="#3-structured-logging-format" title="Permanent link">&para;</a></h3>
<p><strong>Standard Fields (All Messages):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-09-30 14:32:15.123&quot;</span><span class="p">,</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="s2">&quot;model_foundry.training.loop&quot;</span><span class="p">,</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Completed training step&quot;</span><span class="p">,</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>        <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;exp0_baseline&quot;</span><span class="p">,</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>        <span class="s2">&quot;git_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;e7607e6&quot;</span><span class="p">,</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cuda:0&quot;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="p">}</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Training Step Messages:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-09-30 14:32:15.123&quot;</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="s2">&quot;model_foundry.training.loop&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Training step completed&quot;</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;exp0_baseline&quot;</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>        <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">2.456</span><span class="p">,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="s2">&quot;tokens_per_sec&quot;</span><span class="p">:</span> <span class="mi">8500</span><span class="p">,</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="s2">&quot;memory_allocated_gb&quot;</span><span class="p">:</span> <span class="mf">3.2</span><span class="p">,</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="s2">&quot;grad_norm&quot;</span><span class="p">:</span> <span class="mf">1.23</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="p">}</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Error Messages:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-09-30 14:32:15.123&quot;</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="s2">&quot;model_foundry.training.checkpointing&quot;</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to save checkpoint&quot;</span><span class="p">,</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;exp0_baseline&quot;</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>        <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IOError&quot;</span><span class="p">,</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="s2">&quot;Disk full&quot;</span><span class="p">,</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>        <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="p">}</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="4-new-logging-components">4. New Logging Components<a class="headerlink" href="#4-new-logging-components" title="Permanent link">&para;</a></h3>
<h4 id="a-structuredlogger-class">A. <code>StructuredLogger</code> Class<a class="headerlink" href="#a-structuredlogger-class" title="Permanent link">&para;</a></h4>
<p>Wraps Python's logging.Logger with structured logging capabilities:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StructuredLogger</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced logger with structured logging support.&quot;&quot;&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">experiment_config</span><span class="p">:</span> <span class="n">ExperimentConfig</span><span class="p">):</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_base_context</span><span class="p">(</span><span class="n">experiment_config</span><span class="p">)</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_base_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build context that appears in all log messages.&quot;&quot;&quot;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">,</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>            <span class="s2">&quot;git_hash&quot;</span><span class="p">:</span> <span class="n">get_git_commit_hash</span><span class="p">(),</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_device</span><span class="p">())</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="p">}</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_structured</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log a message with structured context.&quot;&quot;&quot;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="p">}</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">log_entry</span><span class="p">))</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log INFO level with context.&quot;&quot;&quot;</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_structured</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log DEBUG level with context.&quot;&quot;&quot;</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_structured</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>    <span class="c1"># ... warning, error, critical methods</span>
</code></pre></div>
<h4 id="b-metricslogger-class">B. <code>MetricsLogger</code> Class<a class="headerlink" href="#b-metricslogger-class" title="Permanent link">&para;</a></h4>
<p>Specialized logger for tracking training metrics:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MetricsLogger</span><span class="p">:</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Logger specifically for training metrics and performance data.&quot;&quot;&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment_name</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_file</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;metrics.jsonl&quot;</span>  <span class="c1"># JSON Lines format</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_foundry.metrics&quot;</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log metrics for a single training step.&quot;&quot;&quot;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">metrics</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="p">}</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>        <span class="c1"># Write to JSONL file for easy analysis</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="c1"># Also log to main logger</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_epoch_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log summary statistics for an epoch.&quot;&quot;&quot;</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="c1"># Similar to log_step but for epoch-level aggregates</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="k">pass</span>
</code></pre></div>
<h4 id="c-performancelogger-class">C. <code>PerformanceLogger</code> Class<a class="headerlink" href="#c-performancelogger-class" title="Permanent link">&para;</a></h4>
<p>Tracks timing and resource usage:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceLogger</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Logger for performance profiling and bottleneck analysis.&quot;&quot;&quot;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="nd">@contextmanager</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager for timing code blocks.&quot;&quot;&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>            <span class="k">yield</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>                           <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">block_name</span><span class="si">}</span><span class="s2"> completed in </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>            <span class="c1"># Track for summary statistics</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>            <span class="k">if</span> <span class="n">block_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">:</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_memory_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log current memory usage.&quot;&quot;&quot;</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>            <span class="n">allocated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1e9</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>            <span class="n">reserved</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1e9</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPU memory - Allocated: </span><span class="si">{</span><span class="n">allocated</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">GB, &quot;</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>                             <span class="sa">f</span><span class="s2">&quot;Reserved: </span><span class="si">{</span><span class="n">reserved</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">GB&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="d-errortracker-class">D. <code>ErrorTracker</code> Class<a class="headerlink" href="#d-errortracker-class" title="Permanent link">&para;</a></h4>
<p>Centralized error tracking and reporting:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ErrorTracker</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Track and aggregate errors during training.&quot;&quot;&quot;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span> <span class="n">experiment_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">/</span> <span class="s2">&quot;errors.jsonl&quot;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log an error with full context and traceback.&quot;&quot;&quot;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>        <span class="n">error_entry</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>            <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>            <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="p">}</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="c1"># Write to error log</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">error_entry</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="c1"># Log to main logger</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>                         <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="c1"># Track counts</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_error_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get summary of all errors encountered.&quot;&quot;&quot;</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="p">)</span>
</code></pre></div>
<h3 id="5-integration-points">5. Integration Points<a class="headerlink" href="#5-integration-points" title="Permanent link">&para;</a></h3>
<h4 id="a-replace-print-in-datapy">A. Replace <code>print()</code> in <code>data.py</code><a class="headerlink" href="#a-replace-print-in-datapy" title="Permanent link">&para;</a></h4>
<p><strong>Before:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Training dataset loaded successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - Training size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> examples&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>After:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training dataset loaded successfully&quot;</span><span class="p">,</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>                 <span class="n">dataset_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>                 <span class="n">columns</span><span class="o">=</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="b-enhanced-training-loop-logging">B. Enhanced Training Loop Logging<a class="headerlink" href="#b-enhanced-training-loop-logging" title="Permanent link">&para;</a></h4>
<p><strong>Before:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting training loop...&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>After:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting training loop&quot;</span><span class="p">,</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>                 <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>                 <span class="n">total_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">train_steps</span><span class="p">,</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>                 <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>                 <span class="n">gradient_accumulation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span><span class="p">,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>                 <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>                 <span class="n">warmup_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="c1"># During training</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;forward_pass&quot;</span><span class="p">):</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="bp">self</span><span class="o">.</span><span class="n">metrics_logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>    <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="n">metrics</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>        <span class="s2">&quot;gradient_norm&quot;</span><span class="p">:</span> <span class="n">grad_norm</span><span class="p">,</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="s2">&quot;tokens_per_second&quot;</span><span class="p">:</span> <span class="n">tokens_per_sec</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="p">}</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="p">)</span>
</code></pre></div></p>
<h4 id="c-checkpoint-saveload-logging">C. Checkpoint Save/Load Logging<a class="headerlink" href="#c-checkpoint-saveload-logging" title="Permanent link">&para;</a></h4>
<p><strong>Enhanced checkpointing logs:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving checkpoint&quot;</span><span class="p">,</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>                     <span class="n">step</span><span class="o">=</span><span class="n">global_step</span><span class="p">,</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>                     <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>                     <span class="n">checkpoint_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">))</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;save_model&quot;</span><span class="p">):</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="n">model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;save_optimizer&quot;</span><span class="p">):</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="s2">&quot;training_state.pt&quot;</span><span class="p">)</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="n">checkpoint_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e9</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checkpoint saved successfully&quot;</span><span class="p">,</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>                     <span class="n">step</span><span class="o">=</span><span class="n">global_step</span><span class="p">,</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>                     <span class="n">checkpoint_size_gb</span><span class="o">=</span><span class="n">checkpoint_size</span><span class="p">,</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>                     <span class="n">save_time_seconds</span><span class="o">=</span><span class="n">total_time</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="6-configuration">6. Configuration<a class="headerlink" href="#6-configuration" title="Permanent link">&para;</a></h3>
<p>Add logging configuration to <code>ExperimentConfig</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoggingConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for logging behavior.&quot;&quot;&quot;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="c1"># Log levels</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="n">console_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Console log level&quot;</span><span class="p">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">file_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;File log level&quot;</span><span class="p">)</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="c1"># Output formats</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    <span class="n">use_structured_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable JSON structured logs&quot;</span><span class="p">)</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="n">log_to_wandb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Send logs to WandB&quot;</span><span class="p">)</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="c1"># Log rotation</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>    <span class="n">max_log_files</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum log files to keep&quot;</span><span class="p">)</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="n">max_log_size_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum size per log file&quot;</span><span class="p">)</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>    <span class="c1"># Metrics logging</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    <span class="n">log_metrics_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Steps between metric logs&quot;</span><span class="p">)</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>    <span class="n">log_detailed_metrics_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Steps between detailed metrics&quot;</span><span class="p">)</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>    <span class="c1"># Performance logging</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>    <span class="n">profile_performance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable performance profiling&quot;</span><span class="p">)</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>    <span class="n">log_memory_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Steps between memory logs&quot;</span><span class="p">)</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>    <span class="c1"># Error tracking</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>    <span class="n">max_errors_to_track</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum errors to track in memory&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="7-log-file-organization">7. Log File Organization<a class="headerlink" href="#7-log-file-organization" title="Permanent link">&para;</a></h3>
<p><strong>Directory Structure:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>logs/
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a> exp0_baseline/
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    main_2025-09-30_14-30-00.log          # General logs
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    metrics_2025-09-30_14-30-00.jsonl     # Training metrics (JSON Lines)
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    errors_2025-09-30_14-30-00.jsonl      # Error tracking
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    performance_2025-09-30_14-30-00.jsonl # Performance profiling
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    debug_2025-09-30_14-30-00.log         # Verbose debug logs
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a> exp1_remove_expletives/
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    ...
</code></pre></div></p>
<p><strong>File Formats:</strong></p>
<ul>
<li><code>.log</code> files: Human-readable text logs</li>
<li><code>.jsonl</code> files: JSON Lines format for programmatic analysis</li>
</ul>
<h3 id="8-monitoring-integration">8. Monitoring Integration<a class="headerlink" href="#8-monitoring-integration" title="Permanent link">&para;</a></h3>
<h4 id="wandb-integration">WandB Integration<a class="headerlink" href="#wandb-integration" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">WandBLogger</span><span class="p">:</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration with Weights &amp; Biases.&quot;&quot;&quot;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ExperimentConfig</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="k">if</span> <span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>            <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>                <span class="n">project</span><span class="o">=</span><span class="s2">&quot;model_foundry&quot;</span><span class="p">,</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>                <span class="n">name</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>            <span class="p">)</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log metrics to WandB.&quot;&quot;&quot;</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_system_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log system resource usage.&quot;&quot;&quot;</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>            <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>                <span class="s2">&quot;system/gpu_memory_allocated&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>                <span class="s2">&quot;system/gpu_memory_reserved&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>            <span class="p">})</span>
</code></pre></div>
<h3 id="9-testing-strategy">9. Testing Strategy<a class="headerlink" href="#9-testing-strategy" title="Permanent link">&para;</a></h3>
<p>See <strong>Unit Tests Section</strong> below for comprehensive test plan.</p>
<hr />
<h2 id="implementation-plan">Implementation Plan<a class="headerlink" href="#implementation-plan" title="Permanent link">&para;</a></h2>
<h3 id="phase-1-core-infrastructure-week-1">Phase 1: Core Infrastructure (Week 1)<a class="headerlink" href="#phase-1-core-infrastructure-week-1" title="Permanent link">&para;</a></h3>
<ol>
<li>Create <code>StructuredLogger</code> class</li>
<li>Create <code>MetricsLogger</code> class</li>
<li>Create <code>PerformanceLogger</code> class</li>
<li>Create <code>ErrorTracker</code> class</li>
<li>Add <code>LoggingConfig</code> to config.py</li>
<li>Write unit tests for all new classes</li>
</ol>
<h3 id="phase-2-integration-week-2">Phase 2: Integration (Week 2)<a class="headerlink" href="#phase-2-integration-week-2" title="Permanent link">&para;</a></h3>
<ol>
<li>Replace all <code>print()</code> statements in <code>data.py</code></li>
<li>Replace all <code>print()</code> statements in <code>model.py</code></li>
<li>Enhance logging in <code>training/loop.py</code></li>
<li>Enhance logging in <code>training/checkpointing.py</code></li>
<li>Enhance logging in <code>training/tokenization.py</code></li>
<li>Write integration tests</li>
</ol>
<h3 id="phase-3-advanced-features-week-3">Phase 3: Advanced Features (Week 3)<a class="headerlink" href="#phase-3-advanced-features-week-3" title="Permanent link">&para;</a></h3>
<ol>
<li>Implement log rotation</li>
<li>Add WandB integration</li>
<li>Create log analysis utilities</li>
<li>Add performance profiling</li>
<li>Write end-to-end tests</li>
</ol>
<h3 id="phase-4-documentation-polish-week-4">Phase 4: Documentation &amp; Polish (Week 4)<a class="headerlink" href="#phase-4-documentation-polish-week-4" title="Permanent link">&para;</a></h3>
<ol>
<li>Update all documentation</li>
<li>Create logging best practices guide</li>
<li>Add logging examples to README</li>
<li>Conduct code review</li>
<li>Performance testing</li>
</ol>
<hr />
<h2 id="migration-guide">Migration Guide<a class="headerlink" href="#migration-guide" title="Permanent link">&para;</a></h2>
<h3 id="for-developers">For Developers<a class="headerlink" href="#for-developers" title="Permanent link">&para;</a></h3>
<p><strong>Old Pattern:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> examples&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>New Pattern:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataset loaded&quot;</span><span class="p">,</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>                 <span class="n">num_examples</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>                 <span class="n">columns</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Error Handling - Old:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">risky_operation</span><span class="p">()</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Error Handling - New:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">risky_operation</span><span class="p">()</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">error_tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>        <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;risky_operation&quot;</span><span class="p">,</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="p">})</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="k">raise</span>  <span class="c1"># Re-raise if fatal, or handle gracefully</span>
</code></pre></div></p>
<hr />
<h2 id="unit-tests-comprehensive-test-plan">Unit Tests - Comprehensive Test Plan<a class="headerlink" href="#unit-tests-comprehensive-test-plan" title="Permanent link">&para;</a></h2>
<h3 id="test-file-testsunittest_loggingpy">Test File: <code>tests/unit/test_logging.py</code><a class="headerlink" href="#test-file-testsunittest_loggingpy" title="Permanent link">&para;</a></h3>
<p><strong>Overview:</strong> 50+ tests covering all logging functionality</p>
<h4 id="1-structuredlogger-tests-15-tests">1. StructuredLogger Tests (15 tests)<a class="headerlink" href="#1-structuredlogger-tests-15-tests" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestStructuredLogger</span><span class="p">:</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the StructuredLogger class.&quot;&quot;&quot;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_creates_logger_with_base_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should create logger with experiment context.&quot;&quot;&quot;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>        <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tiny_config</span><span class="o">.</span><span class="n">experiment_name</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>        <span class="k">assert</span> <span class="s2">&quot;git_hash&quot;</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>        <span class="k">assert</span> <span class="s2">&quot;device&quot;</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_structured_creates_json_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should output structured JSON logs.&quot;&quot;&quot;</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>        <span class="c1"># Setup logger with file handler</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>        <span class="n">log_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;test.log&quot;</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>        <span class="c1"># Log a message</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test message&quot;</span><span class="p">,</span> <span class="n">custom_field</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>        <span class="n">handler</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>        <span class="c1"># Verify JSON structure</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>        <span class="n">log_content</span> <span class="o">=</span> <span class="n">log_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>        <span class="n">log_entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">log_content</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>        <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Test message&quot;</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>        <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tiny_config</span><span class="o">.</span><span class="n">experiment_name</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>        <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;custom_field&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;value&quot;</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_info_level_logs_at_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;info() should log at INFO level.&quot;&quot;&quot;</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test message&quot;</span><span class="p">)</span>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>            <span class="n">mock_log</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>            <span class="k">assert</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_debug_level_logs_at_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;debug() should log at DEBUG level.&quot;&quot;&quot;</span>
<a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>
<a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Test message&quot;</span><span class="p">)</span>
<a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>            <span class="n">mock_log</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>            <span class="k">assert</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
<a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>
<a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_warning_level_logs_at_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;warning() should log at WARNING level.&quot;&quot;&quot;</span>
<a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a>
<a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Test message&quot;</span><span class="p">)</span>
<a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a>            <span class="n">mock_log</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a>            <span class="k">assert</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
<a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a>
<a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_error_level_logs_at_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;error() should log at ERROR level.&quot;&quot;&quot;</span>
<a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a>
<a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Test message&quot;</span><span class="p">)</span>
<a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a>            <span class="n">mock_log</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a>            <span class="k">assert</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span>
<a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a>
<a id="__codelineno-20-68" name="__codelineno-20-68" href="#__codelineno-20-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_critical_level_logs_at_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-69" name="__codelineno-20-69" href="#__codelineno-20-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;critical() should log at CRITICAL level.&quot;&quot;&quot;</span>
<a id="__codelineno-20-70" name="__codelineno-20-70" href="#__codelineno-20-70"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-71" name="__codelineno-20-71" href="#__codelineno-20-71"></a>
<a id="__codelineno-20-72" name="__codelineno-20-72" href="#__codelineno-20-72"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-73" name="__codelineno-20-73" href="#__codelineno-20-73"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Test message&quot;</span><span class="p">)</span>
<a id="__codelineno-20-74" name="__codelineno-20-74" href="#__codelineno-20-74"></a>            <span class="n">mock_log</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-20-75" name="__codelineno-20-75" href="#__codelineno-20-75"></a>            <span class="k">assert</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span>
<a id="__codelineno-20-76" name="__codelineno-20-76" href="#__codelineno-20-76"></a>
<a id="__codelineno-20-77" name="__codelineno-20-77" href="#__codelineno-20-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_context_merges_with_base_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-78" name="__codelineno-20-78" href="#__codelineno-20-78"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom context should merge with base context.&quot;&quot;&quot;</span>
<a id="__codelineno-20-79" name="__codelineno-20-79" href="#__codelineno-20-79"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-80" name="__codelineno-20-80" href="#__codelineno-20-80"></a>
<a id="__codelineno-20-81" name="__codelineno-20-81" href="#__codelineno-20-81"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-82" name="__codelineno-20-82" href="#__codelineno-20-82"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
<a id="__codelineno-20-83" name="__codelineno-20-83" href="#__codelineno-20-83"></a>
<a id="__codelineno-20-84" name="__codelineno-20-84" href="#__codelineno-20-84"></a>            <span class="n">logged_message</span> <span class="o">=</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-20-85" name="__codelineno-20-85" href="#__codelineno-20-85"></a>            <span class="n">log_entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">logged_message</span><span class="p">)</span>
<a id="__codelineno-20-86" name="__codelineno-20-86" href="#__codelineno-20-86"></a>
<a id="__codelineno-20-87" name="__codelineno-20-87" href="#__codelineno-20-87"></a>            <span class="c1"># Should have both base and custom context</span>
<a id="__codelineno-20-88" name="__codelineno-20-88" href="#__codelineno-20-88"></a>            <span class="k">assert</span> <span class="s2">&quot;experiment&quot;</span> <span class="ow">in</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span>
<a id="__codelineno-20-89" name="__codelineno-20-89" href="#__codelineno-20-89"></a>            <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>
<a id="__codelineno-20-90" name="__codelineno-20-90" href="#__codelineno-20-90"></a>            <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.5</span>
<a id="__codelineno-20-91" name="__codelineno-20-91" href="#__codelineno-20-91"></a>
<a id="__codelineno-20-92" name="__codelineno-20-92" href="#__codelineno-20-92"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_custom_context_overrides_base_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-93" name="__codelineno-20-93" href="#__codelineno-20-93"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom context values should override base context.&quot;&quot;&quot;</span>
<a id="__codelineno-20-94" name="__codelineno-20-94" href="#__codelineno-20-94"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-95" name="__codelineno-20-95" href="#__codelineno-20-95"></a>        <span class="n">original_experiment</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span>
<a id="__codelineno-20-96" name="__codelineno-20-96" href="#__codelineno-20-96"></a>
<a id="__codelineno-20-97" name="__codelineno-20-97" href="#__codelineno-20-97"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-98" name="__codelineno-20-98" href="#__codelineno-20-98"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="s2">&quot;override&quot;</span><span class="p">)</span>
<a id="__codelineno-20-99" name="__codelineno-20-99" href="#__codelineno-20-99"></a>
<a id="__codelineno-20-100" name="__codelineno-20-100" href="#__codelineno-20-100"></a>            <span class="n">logged_message</span> <span class="o">=</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-20-101" name="__codelineno-20-101" href="#__codelineno-20-101"></a>            <span class="n">log_entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">logged_message</span><span class="p">)</span>
<a id="__codelineno-20-102" name="__codelineno-20-102" href="#__codelineno-20-102"></a>
<a id="__codelineno-20-103" name="__codelineno-20-103" href="#__codelineno-20-103"></a>            <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;override&quot;</span>
<a id="__codelineno-20-104" name="__codelineno-20-104" href="#__codelineno-20-104"></a>            <span class="c1"># But base context should remain unchanged</span>
<a id="__codelineno-20-105" name="__codelineno-20-105" href="#__codelineno-20-105"></a>            <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">original_experiment</span>
<a id="__codelineno-20-106" name="__codelineno-20-106" href="#__codelineno-20-106"></a>
<a id="__codelineno-20-107" name="__codelineno-20-107" href="#__codelineno-20-107"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_handles_non_serializable_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-108" name="__codelineno-20-108" href="#__codelineno-20-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should handle context values that aren&#39;t JSON serializable.&quot;&quot;&quot;</span>
<a id="__codelineno-20-109" name="__codelineno-20-109" href="#__codelineno-20-109"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-110" name="__codelineno-20-110" href="#__codelineno-20-110"></a>
<a id="__codelineno-20-111" name="__codelineno-20-111" href="#__codelineno-20-111"></a>        <span class="c1"># Should not raise exception</span>
<a id="__codelineno-20-112" name="__codelineno-20-112" href="#__codelineno-20-112"></a>        <span class="k">class</span><span class="w"> </span><span class="nc">NonSerializable</span><span class="p">:</span>
<a id="__codelineno-20-113" name="__codelineno-20-113" href="#__codelineno-20-113"></a>            <span class="k">pass</span>
<a id="__codelineno-20-114" name="__codelineno-20-114" href="#__codelineno-20-114"></a>
<a id="__codelineno-20-115" name="__codelineno-20-115" href="#__codelineno-20-115"></a>        <span class="c1"># This should convert to string representation</span>
<a id="__codelineno-20-116" name="__codelineno-20-116" href="#__codelineno-20-116"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">NonSerializable</span><span class="p">())</span>
<a id="__codelineno-20-117" name="__codelineno-20-117" href="#__codelineno-20-117"></a>        <span class="c1"># Test passes if no exception raised</span>
<a id="__codelineno-20-118" name="__codelineno-20-118" href="#__codelineno-20-118"></a>
<a id="__codelineno-20-119" name="__codelineno-20-119" href="#__codelineno-20-119"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_loggers_independent_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-120" name="__codelineno-20-120" href="#__codelineno-20-120"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiple StructuredLogger instances should have independent contexts.&quot;&quot;&quot;</span>
<a id="__codelineno-20-121" name="__codelineno-20-121" href="#__codelineno-20-121"></a>        <span class="n">logger1</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-122" name="__codelineno-20-122" href="#__codelineno-20-122"></a>        <span class="n">logger2</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test2&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-123" name="__codelineno-20-123" href="#__codelineno-20-123"></a>
<a id="__codelineno-20-124" name="__codelineno-20-124" href="#__codelineno-20-124"></a>        <span class="n">logger1</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;value1&quot;</span>
<a id="__codelineno-20-125" name="__codelineno-20-125" href="#__codelineno-20-125"></a>        <span class="n">logger2</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;value2&quot;</span>
<a id="__codelineno-20-126" name="__codelineno-20-126" href="#__codelineno-20-126"></a>
<a id="__codelineno-20-127" name="__codelineno-20-127" href="#__codelineno-20-127"></a>        <span class="k">assert</span> <span class="n">logger1</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;value1&quot;</span>
<a id="__codelineno-20-128" name="__codelineno-20-128" href="#__codelineno-20-128"></a>        <span class="k">assert</span> <span class="n">logger2</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;value2&quot;</span>
<a id="__codelineno-20-129" name="__codelineno-20-129" href="#__codelineno-20-129"></a>
<a id="__codelineno-20-130" name="__codelineno-20-130" href="#__codelineno-20-130"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_base_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-131" name="__codelineno-20-131" href="#__codelineno-20-131"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should allow updating base context.&quot;&quot;&quot;</span>
<a id="__codelineno-20-132" name="__codelineno-20-132" href="#__codelineno-20-132"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-133" name="__codelineno-20-133" href="#__codelineno-20-133"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">update_context</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-20-134" name="__codelineno-20-134" href="#__codelineno-20-134"></a>
<a id="__codelineno-20-135" name="__codelineno-20-135" href="#__codelineno-20-135"></a>        <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>
<a id="__codelineno-20-136" name="__codelineno-20-136" href="#__codelineno-20-136"></a>        <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-20-137" name="__codelineno-20-137" href="#__codelineno-20-137"></a>
<a id="__codelineno-20-138" name="__codelineno-20-138" href="#__codelineno-20-138"></a>        <span class="c1"># Should appear in all subsequent logs</span>
<a id="__codelineno-20-139" name="__codelineno-20-139" href="#__codelineno-20-139"></a>        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_log</span><span class="p">:</span>
<a id="__codelineno-20-140" name="__codelineno-20-140" href="#__codelineno-20-140"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<a id="__codelineno-20-141" name="__codelineno-20-141" href="#__codelineno-20-141"></a>
<a id="__codelineno-20-142" name="__codelineno-20-142" href="#__codelineno-20-142"></a>            <span class="n">logged_message</span> <span class="o">=</span> <span class="n">mock_log</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-20-143" name="__codelineno-20-143" href="#__codelineno-20-143"></a>            <span class="n">log_entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">logged_message</span><span class="p">)</span>
<a id="__codelineno-20-144" name="__codelineno-20-144" href="#__codelineno-20-144"></a>
<a id="__codelineno-20-145" name="__codelineno-20-145" href="#__codelineno-20-145"></a>            <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>
<a id="__codelineno-20-146" name="__codelineno-20-146" href="#__codelineno-20-146"></a>            <span class="k">assert</span> <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-20-147" name="__codelineno-20-147" href="#__codelineno-20-147"></a>
<a id="__codelineno-20-148" name="__codelineno-20-148" href="#__codelineno-20-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_clear_context_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-20-149" name="__codelineno-20-149" href="#__codelineno-20-149"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should allow removing fields from base context.&quot;&quot;&quot;</span>
<a id="__codelineno-20-150" name="__codelineno-20-150" href="#__codelineno-20-150"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-151" name="__codelineno-20-151" href="#__codelineno-20-151"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">update_context</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-20-152" name="__codelineno-20-152" href="#__codelineno-20-152"></a>        <span class="k">assert</span> <span class="s2">&quot;step&quot;</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span>
<a id="__codelineno-20-153" name="__codelineno-20-153" href="#__codelineno-20-153"></a>
<a id="__codelineno-20-154" name="__codelineno-20-154" href="#__codelineno-20-154"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">clear_context_field</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<a id="__codelineno-20-155" name="__codelineno-20-155" href="#__codelineno-20-155"></a>        <span class="k">assert</span> <span class="s2">&quot;step&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">context</span>
<a id="__codelineno-20-156" name="__codelineno-20-156" href="#__codelineno-20-156"></a>
<a id="__codelineno-20-157" name="__codelineno-20-157" href="#__codelineno-20-157"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_exception_with_traceback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-20-158" name="__codelineno-20-158" href="#__codelineno-20-158"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should log exceptions with full traceback.&quot;&quot;&quot;</span>
<a id="__codelineno-20-159" name="__codelineno-20-159" href="#__codelineno-20-159"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">)</span>
<a id="__codelineno-20-160" name="__codelineno-20-160" href="#__codelineno-20-160"></a>        <span class="n">log_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;test.log&quot;</span>
<a id="__codelineno-20-161" name="__codelineno-20-161" href="#__codelineno-20-161"></a>
<a id="__codelineno-20-162" name="__codelineno-20-162" href="#__codelineno-20-162"></a>        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
<a id="__codelineno-20-163" name="__codelineno-20-163" href="#__codelineno-20-163"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<a id="__codelineno-20-164" name="__codelineno-20-164" href="#__codelineno-20-164"></a>
<a id="__codelineno-20-165" name="__codelineno-20-165" href="#__codelineno-20-165"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-20-166" name="__codelineno-20-166" href="#__codelineno-20-166"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test error&quot;</span><span class="p">)</span>
<a id="__codelineno-20-167" name="__codelineno-20-167" href="#__codelineno-20-167"></a>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-20-168" name="__codelineno-20-168" href="#__codelineno-20-168"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred&quot;</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-20-169" name="__codelineno-20-169" href="#__codelineno-20-169"></a>
<a id="__codelineno-20-170" name="__codelineno-20-170" href="#__codelineno-20-170"></a>        <span class="n">handler</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<a id="__codelineno-20-171" name="__codelineno-20-171" href="#__codelineno-20-171"></a>        <span class="n">log_content</span> <span class="o">=</span> <span class="n">log_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
<a id="__codelineno-20-172" name="__codelineno-20-172" href="#__codelineno-20-172"></a>
<a id="__codelineno-20-173" name="__codelineno-20-173" href="#__codelineno-20-173"></a>        <span class="k">assert</span> <span class="s2">&quot;ValueError&quot;</span> <span class="ow">in</span> <span class="n">log_content</span>
<a id="__codelineno-20-174" name="__codelineno-20-174" href="#__codelineno-20-174"></a>        <span class="k">assert</span> <span class="s2">&quot;Test error&quot;</span> <span class="ow">in</span> <span class="n">log_content</span>
</code></pre></div>
<h4 id="2-metricslogger-tests-12-tests">2. MetricsLogger Tests (12 tests)<a class="headerlink" href="#2-metricslogger-tests-12-tests" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestMetricsLogger</span><span class="p">:</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the MetricsLogger class.&quot;&quot;&quot;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_creates_metrics_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should create metrics.jsonl file.&quot;&quot;&quot;</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>        <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span> <span class="o">==</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;metrics.jsonl&quot;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_step_writes_jsonl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should write metrics to JSONL file.&quot;&quot;&quot;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">}</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>        <span class="c1"># Read JSONL</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.5</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.001</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>        <span class="k">assert</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">entry</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_step_appends_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should append to metrics file, not overwrite.&quot;&quot;&quot;</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">})</span>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">2.3</span><span class="p">})</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a>        <span class="k">assert</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a>        <span class="k">assert</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_epoch_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should log epoch-level summary statistics.&quot;&quot;&quot;</span>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>
<a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a>            <span class="s2">&quot;avg_loss&quot;</span><span class="p">:</span> <span class="mf">2.4</span><span class="p">,</span>
<a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>            <span class="s2">&quot;min_loss&quot;</span><span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
<a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>            <span class="s2">&quot;max_loss&quot;</span><span class="p">:</span> <span class="mf">2.8</span><span class="p">,</span>
<a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>            <span class="s2">&quot;total_tokens&quot;</span><span class="p">:</span> <span class="mi">1000000</span>
<a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>        <span class="p">}</span>
<a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">log_epoch_summary</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">)</span>
<a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a>
<a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>        <span class="c1"># Verify written correctly</span>
<a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a>
<a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>        <span class="k">assert</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="n">entry</span>
<a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;avg_loss&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.4</span>
<a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a>
<a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_metrics_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should retrieve metrics history from file.&quot;&quot;&quot;</span>
<a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a>
<a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a>        <span class="c1"># Log several steps</span>
<a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
<a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">3.0</span> <span class="o">-</span> <span class="n">step</span><span class="o">/</span><span class="mi">1000</span><span class="p">})</span>
<a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a>
<a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a>        <span class="c1"># Retrieve history</span>
<a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a>        <span class="n">history</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_metrics_history</span><span class="p">()</span>
<a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a>
<a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a>        <span class="k">assert</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-21-75" name="__codelineno-21-75" href="#__codelineno-21-75"></a>        <span class="k">assert</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">400</span>
<a id="__codelineno-21-76" name="__codelineno-21-76" href="#__codelineno-21-76"></a>
<a id="__codelineno-21-77" name="__codelineno-21-77" href="#__codelineno-21-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_metrics_for_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-78" name="__codelineno-21-78" href="#__codelineno-21-78"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should filter metrics by step range.&quot;&quot;&quot;</span>
<a id="__codelineno-21-79" name="__codelineno-21-79" href="#__codelineno-21-79"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-80" name="__codelineno-21-80" href="#__codelineno-21-80"></a>
<a id="__codelineno-21-81" name="__codelineno-21-81" href="#__codelineno-21-81"></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
<a id="__codelineno-21-82" name="__codelineno-21-82" href="#__codelineno-21-82"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">3.0</span> <span class="o">-</span> <span class="n">step</span><span class="o">/</span><span class="mi">1000</span><span class="p">})</span>
<a id="__codelineno-21-83" name="__codelineno-21-83" href="#__codelineno-21-83"></a>
<a id="__codelineno-21-84" name="__codelineno-21-84" href="#__codelineno-21-84"></a>        <span class="c1"># Get metrics for steps 200-500</span>
<a id="__codelineno-21-85" name="__codelineno-21-85" href="#__codelineno-21-85"></a>        <span class="n">filtered</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_metrics_for_steps</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<a id="__codelineno-21-86" name="__codelineno-21-86" href="#__codelineno-21-86"></a>
<a id="__codelineno-21-87" name="__codelineno-21-87" href="#__codelineno-21-87"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>  <span class="c1"># 200, 300, 400, 500</span>
<a id="__codelineno-21-88" name="__codelineno-21-88" href="#__codelineno-21-88"></a>        <span class="k">assert</span> <span class="n">filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-21-89" name="__codelineno-21-89" href="#__codelineno-21-89"></a>        <span class="k">assert</span> <span class="n">filtered</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">500</span>
<a id="__codelineno-21-90" name="__codelineno-21-90" href="#__codelineno-21-90"></a>
<a id="__codelineno-21-91" name="__codelineno-21-91" href="#__codelineno-21-91"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_compute_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-92" name="__codelineno-21-92" href="#__codelineno-21-92"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should compute statistics over metrics.&quot;&quot;&quot;</span>
<a id="__codelineno-21-93" name="__codelineno-21-93" href="#__codelineno-21-93"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-94" name="__codelineno-21-94" href="#__codelineno-21-94"></a>
<a id="__codelineno-21-95" name="__codelineno-21-95" href="#__codelineno-21-95"></a>        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">]</span>
<a id="__codelineno-21-96" name="__codelineno-21-96" href="#__codelineno-21-96"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">):</span>
<a id="__codelineno-21-97" name="__codelineno-21-97" href="#__codelineno-21-97"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">})</span>
<a id="__codelineno-21-98" name="__codelineno-21-98" href="#__codelineno-21-98"></a>
<a id="__codelineno-21-99" name="__codelineno-21-99" href="#__codelineno-21-99"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">compute_statistics</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<a id="__codelineno-21-100" name="__codelineno-21-100" href="#__codelineno-21-100"></a>
<a id="__codelineno-21-101" name="__codelineno-21-101" href="#__codelineno-21-101"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">2.6</span><span class="p">)</span>
<a id="__codelineno-21-102" name="__codelineno-21-102" href="#__codelineno-21-102"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.2</span>
<a id="__codelineno-21-103" name="__codelineno-21-103" href="#__codelineno-21-103"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.0</span>
<a id="__codelineno-21-104" name="__codelineno-21-104" href="#__codelineno-21-104"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-21-105" name="__codelineno-21-105" href="#__codelineno-21-105"></a>
<a id="__codelineno-21-106" name="__codelineno-21-106" href="#__codelineno-21-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_gradient_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-107" name="__codelineno-21-107" href="#__codelineno-21-107"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should log gradient norm with metrics.&quot;&quot;&quot;</span>
<a id="__codelineno-21-108" name="__codelineno-21-108" href="#__codelineno-21-108"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-109" name="__codelineno-21-109" href="#__codelineno-21-109"></a>
<a id="__codelineno-21-110" name="__codelineno-21-110" href="#__codelineno-21-110"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-21-111" name="__codelineno-21-111" href="#__codelineno-21-111"></a>            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
<a id="__codelineno-21-112" name="__codelineno-21-112" href="#__codelineno-21-112"></a>            <span class="s2">&quot;grad_norm&quot;</span><span class="p">:</span> <span class="mf">1.23</span>
<a id="__codelineno-21-113" name="__codelineno-21-113" href="#__codelineno-21-113"></a>        <span class="p">})</span>
<a id="__codelineno-21-114" name="__codelineno-21-114" href="#__codelineno-21-114"></a>
<a id="__codelineno-21-115" name="__codelineno-21-115" href="#__codelineno-21-115"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-21-116" name="__codelineno-21-116" href="#__codelineno-21-116"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<a id="__codelineno-21-117" name="__codelineno-21-117" href="#__codelineno-21-117"></a>
<a id="__codelineno-21-118" name="__codelineno-21-118" href="#__codelineno-21-118"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;grad_norm&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.23</span>
<a id="__codelineno-21-119" name="__codelineno-21-119" href="#__codelineno-21-119"></a>
<a id="__codelineno-21-120" name="__codelineno-21-120" href="#__codelineno-21-120"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_learning_rate_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-121" name="__codelineno-21-121" href="#__codelineno-21-121"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should track learning rate changes.&quot;&quot;&quot;</span>
<a id="__codelineno-21-122" name="__codelineno-21-122" href="#__codelineno-21-122"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-123" name="__codelineno-21-123" href="#__codelineno-21-123"></a>
<a id="__codelineno-21-124" name="__codelineno-21-124" href="#__codelineno-21-124"></a>        <span class="c1"># Simulate warmup + decay</span>
<a id="__codelineno-21-125" name="__codelineno-21-125" href="#__codelineno-21-125"></a>        <span class="n">lrs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0009</span><span class="p">,</span> <span class="mf">0.0008</span><span class="p">]</span>
<a id="__codelineno-21-126" name="__codelineno-21-126" href="#__codelineno-21-126"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lrs</span><span class="p">):</span>
<a id="__codelineno-21-127" name="__codelineno-21-127" href="#__codelineno-21-127"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">lr</span><span class="p">})</span>
<a id="__codelineno-21-128" name="__codelineno-21-128" href="#__codelineno-21-128"></a>
<a id="__codelineno-21-129" name="__codelineno-21-129" href="#__codelineno-21-129"></a>        <span class="n">history</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_metrics_history</span><span class="p">()</span>
<a id="__codelineno-21-130" name="__codelineno-21-130" href="#__codelineno-21-130"></a>        <span class="n">logged_lrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span><span class="p">]</span>
<a id="__codelineno-21-131" name="__codelineno-21-131" href="#__codelineno-21-131"></a>
<a id="__codelineno-21-132" name="__codelineno-21-132" href="#__codelineno-21-132"></a>        <span class="k">assert</span> <span class="n">logged_lrs</span> <span class="o">==</span> <span class="n">lrs</span>
<a id="__codelineno-21-133" name="__codelineno-21-133" href="#__codelineno-21-133"></a>
<a id="__codelineno-21-134" name="__codelineno-21-134" href="#__codelineno-21-134"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_throughput_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-135" name="__codelineno-21-135" href="#__codelineno-21-135"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should log tokens/sec and other throughput metrics.&quot;&quot;&quot;</span>
<a id="__codelineno-21-136" name="__codelineno-21-136" href="#__codelineno-21-136"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-137" name="__codelineno-21-137" href="#__codelineno-21-137"></a>
<a id="__codelineno-21-138" name="__codelineno-21-138" href="#__codelineno-21-138"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-21-139" name="__codelineno-21-139" href="#__codelineno-21-139"></a>            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
<a id="__codelineno-21-140" name="__codelineno-21-140" href="#__codelineno-21-140"></a>            <span class="s2">&quot;tokens_per_sec&quot;</span><span class="p">:</span> <span class="mi">8500</span><span class="p">,</span>
<a id="__codelineno-21-141" name="__codelineno-21-141" href="#__codelineno-21-141"></a>            <span class="s2">&quot;samples_per_sec&quot;</span><span class="p">:</span> <span class="mi">42</span>
<a id="__codelineno-21-142" name="__codelineno-21-142" href="#__codelineno-21-142"></a>        <span class="p">})</span>
<a id="__codelineno-21-143" name="__codelineno-21-143" href="#__codelineno-21-143"></a>
<a id="__codelineno-21-144" name="__codelineno-21-144" href="#__codelineno-21-144"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-21-145" name="__codelineno-21-145" href="#__codelineno-21-145"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<a id="__codelineno-21-146" name="__codelineno-21-146" href="#__codelineno-21-146"></a>
<a id="__codelineno-21-147" name="__codelineno-21-147" href="#__codelineno-21-147"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;tokens_per_sec&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8500</span>
<a id="__codelineno-21-148" name="__codelineno-21-148" href="#__codelineno-21-148"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;samples_per_sec&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">42</span>
<a id="__codelineno-21-149" name="__codelineno-21-149" href="#__codelineno-21-149"></a>
<a id="__codelineno-21-150" name="__codelineno-21-150" href="#__codelineno-21-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_handles_nan_inf_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-151" name="__codelineno-21-151" href="#__codelineno-21-151"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should handle NaN and Inf metric values gracefully.&quot;&quot;&quot;</span>
<a id="__codelineno-21-152" name="__codelineno-21-152" href="#__codelineno-21-152"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-153" name="__codelineno-21-153" href="#__codelineno-21-153"></a>
<a id="__codelineno-21-154" name="__codelineno-21-154" href="#__codelineno-21-154"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-21-155" name="__codelineno-21-155" href="#__codelineno-21-155"></a>            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span>
<a id="__codelineno-21-156" name="__codelineno-21-156" href="#__codelineno-21-156"></a>            <span class="s2">&quot;grad_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<a id="__codelineno-21-157" name="__codelineno-21-157" href="#__codelineno-21-157"></a>        <span class="p">})</span>
<a id="__codelineno-21-158" name="__codelineno-21-158" href="#__codelineno-21-158"></a>
<a id="__codelineno-21-159" name="__codelineno-21-159" href="#__codelineno-21-159"></a>        <span class="c1"># Should write successfully (JSON supports these)</span>
<a id="__codelineno-21-160" name="__codelineno-21-160" href="#__codelineno-21-160"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-21-161" name="__codelineno-21-161" href="#__codelineno-21-161"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<a id="__codelineno-21-162" name="__codelineno-21-162" href="#__codelineno-21-162"></a>
<a id="__codelineno-21-163" name="__codelineno-21-163" href="#__codelineno-21-163"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span>  <span class="c1"># NaN check</span>
<a id="__codelineno-21-164" name="__codelineno-21-164" href="#__codelineno-21-164"></a>
<a id="__codelineno-21-165" name="__codelineno-21-165" href="#__codelineno-21-165"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_concurrent_writes_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-21-166" name="__codelineno-21-166" href="#__codelineno-21-166"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should handle concurrent writes without corruption.&quot;&quot;&quot;</span>
<a id="__codelineno-21-167" name="__codelineno-21-167" href="#__codelineno-21-167"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">(</span><span class="s2">&quot;test_exp&quot;</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-21-168" name="__codelineno-21-168" href="#__codelineno-21-168"></a>
<a id="__codelineno-21-169" name="__codelineno-21-169" href="#__codelineno-21-169"></a>        <span class="c1"># Simulate multiple threads/processes writing</span>
<a id="__codelineno-21-170" name="__codelineno-21-170" href="#__codelineno-21-170"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<a id="__codelineno-21-171" name="__codelineno-21-171" href="#__codelineno-21-171"></a>
<a id="__codelineno-21-172" name="__codelineno-21-172" href="#__codelineno-21-172"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">write_metrics</span><span class="p">(</span><span class="n">start_step</span><span class="p">):</span>
<a id="__codelineno-21-173" name="__codelineno-21-173" href="#__codelineno-21-173"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-21-174" name="__codelineno-21-174" href="#__codelineno-21-174"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">log_step</span><span class="p">(</span><span class="n">start_step</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">})</span>
<a id="__codelineno-21-175" name="__codelineno-21-175" href="#__codelineno-21-175"></a>
<a id="__codelineno-21-176" name="__codelineno-21-176" href="#__codelineno-21-176"></a>        <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-21-177" name="__codelineno-21-177" href="#__codelineno-21-177"></a>            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">write_metrics</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,))</span>
<a id="__codelineno-21-178" name="__codelineno-21-178" href="#__codelineno-21-178"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-21-179" name="__codelineno-21-179" href="#__codelineno-21-179"></a>        <span class="p">]</span>
<a id="__codelineno-21-180" name="__codelineno-21-180" href="#__codelineno-21-180"></a>
<a id="__codelineno-21-181" name="__codelineno-21-181" href="#__codelineno-21-181"></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
<a id="__codelineno-21-182" name="__codelineno-21-182" href="#__codelineno-21-182"></a>            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-21-183" name="__codelineno-21-183" href="#__codelineno-21-183"></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
<a id="__codelineno-21-184" name="__codelineno-21-184" href="#__codelineno-21-184"></a>            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<a id="__codelineno-21-185" name="__codelineno-21-185" href="#__codelineno-21-185"></a>
<a id="__codelineno-21-186" name="__codelineno-21-186" href="#__codelineno-21-186"></a>        <span class="c1"># Should have 50 entries</span>
<a id="__codelineno-21-187" name="__codelineno-21-187" href="#__codelineno-21-187"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-21-188" name="__codelineno-21-188" href="#__codelineno-21-188"></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-21-189" name="__codelineno-21-189" href="#__codelineno-21-189"></a>
<a id="__codelineno-21-190" name="__codelineno-21-190" href="#__codelineno-21-190"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">50</span>
<a id="__codelineno-21-191" name="__codelineno-21-191" href="#__codelineno-21-191"></a>        <span class="c1"># All should be valid JSON</span>
<a id="__codelineno-21-192" name="__codelineno-21-192" href="#__codelineno-21-192"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<a id="__codelineno-21-193" name="__codelineno-21-193" href="#__codelineno-21-193"></a>            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>  <span class="c1"># Should not raise</span>
</code></pre></div>
<h4 id="3-performancelogger-tests-10-tests">3. PerformanceLogger Tests (10 tests)<a class="headerlink" href="#3-performancelogger-tests-10-tests" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestPerformanceLogger</span><span class="p">:</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the PerformanceLogger class.&quot;&quot;&quot;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_time_block_measures_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should measure execution time of code block.&quot;&quot;&quot;</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;test_operation&quot;</span><span class="p">):</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="k">assert</span> <span class="s2">&quot;test_operation&quot;</span> <span class="ow">in</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;test_operation&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>        <span class="k">assert</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;test_operation&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.1</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_time_block_logs_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should log duration to logger.&quot;&quot;&quot;</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="k">with</span> <span class="n">caplog</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>            <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;test_operation&quot;</span><span class="p">):</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>        <span class="k">assert</span> <span class="s2">&quot;test_operation completed in&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_time_block_tracks_multiple_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should track multiple invocations of same block.&quot;&quot;&quot;</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>            <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;repeated_op&quot;</span><span class="p">):</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;repeated_op&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_time_block_handles_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should still log timing even if block raises exception.&quot;&quot;&quot;</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>            <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;failing_op&quot;</span><span class="p">):</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test error&quot;</span><span class="p">)</span>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>        <span class="c1"># Should still have timing recorded</span>
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>        <span class="k">assert</span> <span class="s2">&quot;failing_op&quot;</span> <span class="ow">in</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span>
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;failing_op&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a>
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_timing_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should compute statistics over multiple timings.&quot;&quot;&quot;</span>
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>
<a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a>        <span class="n">durations</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">]</span>
<a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">durations</span><span class="p">:</span>
<a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a>            <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;test_op&quot;</span><span class="p">):</span>
<a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>
<a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">get_timing_statistics</span><span class="p">(</span><span class="s2">&quot;test_op&quot;</span><span class="p">)</span>
<a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a>
<a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span>
<a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.1</span>
<a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a>        <span class="k">assert</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.2</span>
<a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a>
<a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_memory_usage_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should log CPU memory usage.&quot;&quot;&quot;</span>
<a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<a id="__codelineno-22-73" name="__codelineno-22-73" href="#__codelineno-22-73"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-74" name="__codelineno-22-74" href="#__codelineno-22-74"></a>
<a id="__codelineno-22-75" name="__codelineno-22-75" href="#__codelineno-22-75"></a>        <span class="k">with</span> <span class="n">caplog</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<a id="__codelineno-22-76" name="__codelineno-22-76" href="#__codelineno-22-76"></a>            <span class="n">perf_logger</span><span class="o">.</span><span class="n">log_memory_usage</span><span class="p">()</span>
<a id="__codelineno-22-77" name="__codelineno-22-77" href="#__codelineno-22-77"></a>
<a id="__codelineno-22-78" name="__codelineno-22-78" href="#__codelineno-22-78"></a>        <span class="c1"># Should log something (format depends on CUDA availability)</span>
<a id="__codelineno-22-79" name="__codelineno-22-79" href="#__codelineno-22-79"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-22-80" name="__codelineno-22-80" href="#__codelineno-22-80"></a>
<a id="__codelineno-22-81" name="__codelineno-22-81" href="#__codelineno-22-81"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">gpu</span>
<a id="__codelineno-22-82" name="__codelineno-22-82" href="#__codelineno-22-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_memory_usage_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<a id="__codelineno-22-83" name="__codelineno-22-83" href="#__codelineno-22-83"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should log GPU memory usage when CUDA available.&quot;&quot;&quot;</span>
<a id="__codelineno-22-84" name="__codelineno-22-84" href="#__codelineno-22-84"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a id="__codelineno-22-85" name="__codelineno-22-85" href="#__codelineno-22-85"></a>            <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;CUDA not available&quot;</span><span class="p">)</span>
<a id="__codelineno-22-86" name="__codelineno-22-86" href="#__codelineno-22-86"></a>
<a id="__codelineno-22-87" name="__codelineno-22-87" href="#__codelineno-22-87"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-88" name="__codelineno-22-88" href="#__codelineno-22-88"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<a id="__codelineno-22-89" name="__codelineno-22-89" href="#__codelineno-22-89"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-90" name="__codelineno-22-90" href="#__codelineno-22-90"></a>
<a id="__codelineno-22-91" name="__codelineno-22-91" href="#__codelineno-22-91"></a>        <span class="k">with</span> <span class="n">caplog</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<a id="__codelineno-22-92" name="__codelineno-22-92" href="#__codelineno-22-92"></a>            <span class="n">perf_logger</span><span class="o">.</span><span class="n">log_memory_usage</span><span class="p">()</span>
<a id="__codelineno-22-93" name="__codelineno-22-93" href="#__codelineno-22-93"></a>
<a id="__codelineno-22-94" name="__codelineno-22-94" href="#__codelineno-22-94"></a>        <span class="k">assert</span> <span class="s2">&quot;GPU memory&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-22-95" name="__codelineno-22-95" href="#__codelineno-22-95"></a>        <span class="k">assert</span> <span class="s2">&quot;Allocated&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-22-96" name="__codelineno-22-96" href="#__codelineno-22-96"></a>
<a id="__codelineno-22-97" name="__codelineno-22-97" href="#__codelineno-22-97"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_reset_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-22-98" name="__codelineno-22-98" href="#__codelineno-22-98"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should clear all timing data.&quot;&quot;&quot;</span>
<a id="__codelineno-22-99" name="__codelineno-22-99" href="#__codelineno-22-99"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-100" name="__codelineno-22-100" href="#__codelineno-22-100"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-101" name="__codelineno-22-101" href="#__codelineno-22-101"></a>
<a id="__codelineno-22-102" name="__codelineno-22-102" href="#__codelineno-22-102"></a>        <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;test_op&quot;</span><span class="p">):</span>
<a id="__codelineno-22-103" name="__codelineno-22-103" href="#__codelineno-22-103"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-22-104" name="__codelineno-22-104" href="#__codelineno-22-104"></a>
<a id="__codelineno-22-105" name="__codelineno-22-105" href="#__codelineno-22-105"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;test_op&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-22-106" name="__codelineno-22-106" href="#__codelineno-22-106"></a>
<a id="__codelineno-22-107" name="__codelineno-22-107" href="#__codelineno-22-107"></a>        <span class="n">perf_logger</span><span class="o">.</span><span class="n">reset_timers</span><span class="p">()</span>
<a id="__codelineno-22-108" name="__codelineno-22-108" href="#__codelineno-22-108"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-22-109" name="__codelineno-22-109" href="#__codelineno-22-109"></a>
<a id="__codelineno-22-110" name="__codelineno-22-110" href="#__codelineno-22-110"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_export_timing_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-22-111" name="__codelineno-22-111" href="#__codelineno-22-111"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should export timing data to JSON file.&quot;&quot;&quot;</span>
<a id="__codelineno-22-112" name="__codelineno-22-112" href="#__codelineno-22-112"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-113" name="__codelineno-22-113" href="#__codelineno-22-113"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-114" name="__codelineno-22-114" href="#__codelineno-22-114"></a>
<a id="__codelineno-22-115" name="__codelineno-22-115" href="#__codelineno-22-115"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-22-116" name="__codelineno-22-116" href="#__codelineno-22-116"></a>            <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;op1&quot;</span><span class="p">):</span>
<a id="__codelineno-22-117" name="__codelineno-22-117" href="#__codelineno-22-117"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-22-118" name="__codelineno-22-118" href="#__codelineno-22-118"></a>            <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;op2&quot;</span><span class="p">):</span>
<a id="__codelineno-22-119" name="__codelineno-22-119" href="#__codelineno-22-119"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-22-120" name="__codelineno-22-120" href="#__codelineno-22-120"></a>
<a id="__codelineno-22-121" name="__codelineno-22-121" href="#__codelineno-22-121"></a>        <span class="n">report_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;timing_report.json&quot;</span>
<a id="__codelineno-22-122" name="__codelineno-22-122" href="#__codelineno-22-122"></a>        <span class="n">perf_logger</span><span class="o">.</span><span class="n">export_timing_report</span><span class="p">(</span><span class="n">report_file</span><span class="p">)</span>
<a id="__codelineno-22-123" name="__codelineno-22-123" href="#__codelineno-22-123"></a>
<a id="__codelineno-22-124" name="__codelineno-22-124" href="#__codelineno-22-124"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-22-125" name="__codelineno-22-125" href="#__codelineno-22-125"></a>            <span class="n">report</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-22-126" name="__codelineno-22-126" href="#__codelineno-22-126"></a>
<a id="__codelineno-22-127" name="__codelineno-22-127" href="#__codelineno-22-127"></a>        <span class="k">assert</span> <span class="s2">&quot;op1&quot;</span> <span class="ow">in</span> <span class="n">report</span>
<a id="__codelineno-22-128" name="__codelineno-22-128" href="#__codelineno-22-128"></a>        <span class="k">assert</span> <span class="s2">&quot;op2&quot;</span> <span class="ow">in</span> <span class="n">report</span>
<a id="__codelineno-22-129" name="__codelineno-22-129" href="#__codelineno-22-129"></a>        <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;op1&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
<a id="__codelineno-22-130" name="__codelineno-22-130" href="#__codelineno-22-130"></a>        <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;op2&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
<a id="__codelineno-22-131" name="__codelineno-22-131" href="#__codelineno-22-131"></a>
<a id="__codelineno-22-132" name="__codelineno-22-132" href="#__codelineno-22-132"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_nested_time_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-22-133" name="__codelineno-22-133" href="#__codelineno-22-133"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should handle nested timing blocks.&quot;&quot;&quot;</span>
<a id="__codelineno-22-134" name="__codelineno-22-134" href="#__codelineno-22-134"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-22-135" name="__codelineno-22-135" href="#__codelineno-22-135"></a>        <span class="n">perf_logger</span> <span class="o">=</span> <span class="n">PerformanceLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-22-136" name="__codelineno-22-136" href="#__codelineno-22-136"></a>
<a id="__codelineno-22-137" name="__codelineno-22-137" href="#__codelineno-22-137"></a>        <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;outer&quot;</span><span class="p">):</span>
<a id="__codelineno-22-138" name="__codelineno-22-138" href="#__codelineno-22-138"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<a id="__codelineno-22-139" name="__codelineno-22-139" href="#__codelineno-22-139"></a>            <span class="k">with</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">time_block</span><span class="p">(</span><span class="s2">&quot;inner&quot;</span><span class="p">):</span>
<a id="__codelineno-22-140" name="__codelineno-22-140" href="#__codelineno-22-140"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-22-141" name="__codelineno-22-141" href="#__codelineno-22-141"></a>
<a id="__codelineno-22-142" name="__codelineno-22-142" href="#__codelineno-22-142"></a>        <span class="k">assert</span> <span class="s2">&quot;outer&quot;</span> <span class="ow">in</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span>
<a id="__codelineno-22-143" name="__codelineno-22-143" href="#__codelineno-22-143"></a>        <span class="k">assert</span> <span class="s2">&quot;inner&quot;</span> <span class="ow">in</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span>
<a id="__codelineno-22-144" name="__codelineno-22-144" href="#__codelineno-22-144"></a>        <span class="c1"># Outer should be longer than inner</span>
<a id="__codelineno-22-145" name="__codelineno-22-145" href="#__codelineno-22-145"></a>        <span class="k">assert</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;outer&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">perf_logger</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;inner&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<h4 id="4-errortracker-tests-8-tests">4. ErrorTracker Tests (8 tests)<a class="headerlink" href="#4-errortracker-tests-8-tests" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestErrorTracker</span><span class="p">:</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the ErrorTracker class.&quot;&quot;&quot;</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_error_writes_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should write error to JSONL file.&quot;&quot;&quot;</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test error&quot;</span><span class="p">)</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>            <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>        <span class="n">error_log</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;errors.jsonl&quot;</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>        <span class="k">assert</span> <span class="n">error_log</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_log</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ValueError&quot;</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;error_message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Test error&quot;</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>        <span class="k">assert</span> <span class="s2">&quot;traceback&quot;</span> <span class="ow">in</span> <span class="n">entry</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_error_increments_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should track error counts by type.&quot;&quot;&quot;</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>                <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>                <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>        <span class="n">summary</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_error_summary</span><span class="p">()</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>        <span class="k">assert</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;ValueError&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>        <span class="k">assert</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;TypeError&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_error_includes_traceback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should include full traceback in error log.&quot;&quot;&quot;</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">nested_function</span><span class="p">():</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Nested error&quot;</span><span class="p">)</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>            <span class="n">nested_function</span><span class="p">()</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a>        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>            <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;errors.jsonl&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a>        <span class="k">assert</span> <span class="s2">&quot;nested_function&quot;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;traceback&quot;</span><span class="p">]</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a>        <span class="k">assert</span> <span class="s2">&quot;RuntimeError&quot;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;traceback&quot;</span><span class="p">]</span>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_error_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should return dictionary of error counts.&quot;&quot;&quot;</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">]</span>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a>        <span class="k">for</span> <span class="n">error_cls</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a>                <span class="k">raise</span> <span class="n">error_cls</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a>            <span class="k">except</span> <span class="n">error_cls</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a>                <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a>
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a>        <span class="n">summary</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_error_summary</span><span class="p">()</span>
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a>        <span class="k">assert</span> <span class="n">summary</span> <span class="o">==</span> <span class="p">{</span>
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a>            <span class="s2">&quot;ValueError&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>            <span class="s2">&quot;TypeError&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a>            <span class="s2">&quot;RuntimeError&quot;</span><span class="p">:</span> <span class="mi">1</span>
<a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a>        <span class="p">}</span>
<a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a>
<a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_log_error_with_no_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should handle logging error without context.&quot;&quot;&quot;</span>
<a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a>
<a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-90" name="__codelineno-23-90" href="#__codelineno-23-90"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-91" name="__codelineno-23-91" href="#__codelineno-23-91"></a>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-92" name="__codelineno-23-92" href="#__codelineno-23-92"></a>            <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># No context</span>
<a id="__codelineno-23-93" name="__codelineno-23-93" href="#__codelineno-23-93"></a>
<a id="__codelineno-23-94" name="__codelineno-23-94" href="#__codelineno-23-94"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;errors.jsonl&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-23-95" name="__codelineno-23-95" href="#__codelineno-23-95"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<a id="__codelineno-23-96" name="__codelineno-23-96" href="#__codelineno-23-96"></a>
<a id="__codelineno-23-97" name="__codelineno-23-97" href="#__codelineno-23-97"></a>        <span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">{}</span>
<a id="__codelineno-23-98" name="__codelineno-23-98" href="#__codelineno-23-98"></a>
<a id="__codelineno-23-99" name="__codelineno-23-99" href="#__codelineno-23-99"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_reset_error_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-100" name="__codelineno-23-100" href="#__codelineno-23-100"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should reset error counters.&quot;&quot;&quot;</span>
<a id="__codelineno-23-101" name="__codelineno-23-101" href="#__codelineno-23-101"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-102" name="__codelineno-23-102" href="#__codelineno-23-102"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-23-103" name="__codelineno-23-103" href="#__codelineno-23-103"></a>
<a id="__codelineno-23-104" name="__codelineno-23-104" href="#__codelineno-23-104"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-105" name="__codelineno-23-105" href="#__codelineno-23-105"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-106" name="__codelineno-23-106" href="#__codelineno-23-106"></a>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-107" name="__codelineno-23-107" href="#__codelineno-23-107"></a>            <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-23-108" name="__codelineno-23-108" href="#__codelineno-23-108"></a>
<a id="__codelineno-23-109" name="__codelineno-23-109" href="#__codelineno-23-109"></a>        <span class="k">assert</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_error_summary</span><span class="p">()[</span><span class="s2">&quot;ValueError&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-23-110" name="__codelineno-23-110" href="#__codelineno-23-110"></a>
<a id="__codelineno-23-111" name="__codelineno-23-111" href="#__codelineno-23-111"></a>        <span class="n">tracker</span><span class="o">.</span><span class="n">reset_counters</span><span class="p">()</span>
<a id="__codelineno-23-112" name="__codelineno-23-112" href="#__codelineno-23-112"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_error_summary</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-23-113" name="__codelineno-23-113" href="#__codelineno-23-113"></a>
<a id="__codelineno-23-114" name="__codelineno-23-114" href="#__codelineno-23-114"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_max_errors_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-115" name="__codelineno-23-115" href="#__codelineno-23-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should limit number of errors tracked in memory.&quot;&quot;&quot;</span>
<a id="__codelineno-23-116" name="__codelineno-23-116" href="#__codelineno-23-116"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-117" name="__codelineno-23-117" href="#__codelineno-23-117"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">,</span> <span class="n">max_errors</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-23-118" name="__codelineno-23-118" href="#__codelineno-23-118"></a>
<a id="__codelineno-23-119" name="__codelineno-23-119" href="#__codelineno-23-119"></a>        <span class="c1"># Log 15 errors</span>
<a id="__codelineno-23-120" name="__codelineno-23-120" href="#__codelineno-23-120"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
<a id="__codelineno-23-121" name="__codelineno-23-121" href="#__codelineno-23-121"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-122" name="__codelineno-23-122" href="#__codelineno-23-122"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-123" name="__codelineno-23-123" href="#__codelineno-23-123"></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-124" name="__codelineno-23-124" href="#__codelineno-23-124"></a>                <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-23-125" name="__codelineno-23-125" href="#__codelineno-23-125"></a>
<a id="__codelineno-23-126" name="__codelineno-23-126" href="#__codelineno-23-126"></a>        <span class="c1"># Counter should still be accurate</span>
<a id="__codelineno-23-127" name="__codelineno-23-127" href="#__codelineno-23-127"></a>        <span class="k">assert</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_error_summary</span><span class="p">()[</span><span class="s2">&quot;ValueError&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">15</span>
<a id="__codelineno-23-128" name="__codelineno-23-128" href="#__codelineno-23-128"></a>
<a id="__codelineno-23-129" name="__codelineno-23-129" href="#__codelineno-23-129"></a>        <span class="c1"># But in-memory storage should be limited</span>
<a id="__codelineno-23-130" name="__codelineno-23-130" href="#__codelineno-23-130"></a>        <span class="c1"># (Implementation detail - depends on whether we keep errors in memory)</span>
<a id="__codelineno-23-131" name="__codelineno-23-131" href="#__codelineno-23-131"></a>
<a id="__codelineno-23-132" name="__codelineno-23-132" href="#__codelineno-23-132"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_recent_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<a id="__codelineno-23-133" name="__codelineno-23-133" href="#__codelineno-23-133"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should retrieve most recent errors.&quot;&quot;&quot;</span>
<a id="__codelineno-23-134" name="__codelineno-23-134" href="#__codelineno-23-134"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-23-135" name="__codelineno-23-135" href="#__codelineno-23-135"></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">ErrorTracker</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
<a id="__codelineno-23-136" name="__codelineno-23-136" href="#__codelineno-23-136"></a>
<a id="__codelineno-23-137" name="__codelineno-23-137" href="#__codelineno-23-137"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-23-138" name="__codelineno-23-138" href="#__codelineno-23-138"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-139" name="__codelineno-23-139" href="#__codelineno-23-139"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-140" name="__codelineno-23-140" href="#__codelineno-23-140"></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-141" name="__codelineno-23-141" href="#__codelineno-23-141"></a>                <span class="n">tracker</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
<a id="__codelineno-23-142" name="__codelineno-23-142" href="#__codelineno-23-142"></a>
<a id="__codelineno-23-143" name="__codelineno-23-143" href="#__codelineno-23-143"></a>        <span class="n">recent</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_recent_errors</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-23-144" name="__codelineno-23-144" href="#__codelineno-23-144"></a>
<a id="__codelineno-23-145" name="__codelineno-23-145" href="#__codelineno-23-145"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
<a id="__codelineno-23-146" name="__codelineno-23-146" href="#__codelineno-23-146"></a>        <span class="c1"># Should be most recent (9, 8, 7)</span>
<a id="__codelineno-23-147" name="__codelineno-23-147" href="#__codelineno-23-147"></a>        <span class="k">assert</span> <span class="n">recent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span>
<a id="__codelineno-23-148" name="__codelineno-23-148" href="#__codelineno-23-148"></a>        <span class="k">assert</span> <span class="n">recent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span>
<a id="__codelineno-23-149" name="__codelineno-23-149" href="#__codelineno-23-149"></a>        <span class="k">assert</span> <span class="n">recent</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span>
</code></pre></div>
<h4 id="5-loggingconfig-tests-5-tests">5. LoggingConfig Tests (5 tests)<a class="headerlink" href="#5-loggingconfig-tests-5-tests" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLoggingConfig</span><span class="p">:</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the LoggingConfig dataclass.&quot;&quot;&quot;</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_default_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should have sensible default values.&quot;&quot;&quot;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">LoggingConfig</span><span class="p">()</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">console_level</span> <span class="o">==</span> <span class="s2">&quot;INFO&quot;</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">file_level</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">use_structured_logging</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">log_to_wandb</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">max_log_files</span> <span class="o">==</span> <span class="mi">10</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_custom_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should accept custom configuration.&quot;&quot;&quot;</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">LoggingConfig</span><span class="p">(</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>            <span class="n">console_level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">,</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>            <span class="n">file_level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>            <span class="n">use_structured_logging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>            <span class="n">max_log_files</span><span class="o">=</span><span class="mi">5</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>        <span class="p">)</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">console_level</span> <span class="o">==</span> <span class="s2">&quot;WARNING&quot;</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">file_level</span> <span class="o">==</span> <span class="s2">&quot;INFO&quot;</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">use_structured_logging</span> <span class="ow">is</span> <span class="kc">False</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">max_log_files</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_validates_log_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should validate log level values.&quot;&quot;&quot;</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>        <span class="n">valid_levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">]</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">valid_levels</span><span class="p">:</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">LoggingConfig</span><span class="p">(</span><span class="n">console_level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>            <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">console_level</span> <span class="o">==</span> <span class="n">level</span>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>        <span class="c1"># Invalid level should raise</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>            <span class="n">LoggingConfig</span><span class="p">(</span><span class="n">console_level</span><span class="o">=</span><span class="s2">&quot;INVALID&quot;</span><span class="p">)</span>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_validates_positive_integers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should validate positive integer fields.&quot;&quot;&quot;</span>
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
<a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>            <span class="n">LoggingConfig</span><span class="p">(</span><span class="n">max_log_files</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>
<a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
<a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>            <span class="n">LoggingConfig</span><span class="p">(</span><span class="n">max_log_size_mb</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>
<a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_integrates_with_experiment_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">):</span>
<a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Should integrate with ExperimentConfig.&quot;&quot;&quot;</span>
<a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>        <span class="c1"># Add logging config to experiment config</span>
<a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">tiny_config</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LoggingConfig</span><span class="p">(</span><span class="n">console_level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>
<a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>        <span class="c1"># Should validate successfully</span>
<a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a>        <span class="n">full_config</span> <span class="o">=</span> <span class="n">ExperimentConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
<a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a>        <span class="k">assert</span> <span class="n">full_config</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">console_level</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span>
</code></pre></div>
<h3 id="test-file-testsintegrationtest_logging_integrationpy">Test File: <code>tests/integration/test_logging_integration.py</code><a class="headerlink" href="#test-file-testsintegrationtest_logging_integrationpy" title="Permanent link">&para;</a></h3>
<p><strong>Overview:</strong> 15+ integration tests</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLoggingIntegration</span><span class="p">:</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration tests for logging across the training pipeline.&quot;&quot;&quot;</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_trainer_uses_structured_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">,</span> <span class="n">temp_workspace</span><span class="p">):</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trainer should use structured logging throughout.&quot;&quot;&quot;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>        <span class="c1"># Create trainer with structured logging enabled</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">tiny_config</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp_workspace</span><span class="p">))</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>        <span class="c1"># Verify logger is StructuredLogger instance</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">StructuredLogger</span><span class="p">)</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_training_loop_logs_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">,</span> <span class="n">temp_workspace</span><span class="p">,</span> <span class="n">mock_tokenizer</span><span class="p">):</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Training loop should log metrics at regular intervals.&quot;&quot;&quot;</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>        <span class="c1"># Run short training</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>        <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">tiny_config</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp_workspace</span><span class="p">))</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>        <span class="c1"># ... setup and run training ...</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>        <span class="c1"># Check metrics file exists</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>        <span class="n">metrics_file</span> <span class="o">=</span> <span class="n">temp_workspace</span> <span class="o">/</span> <span class="s2">&quot;test&quot;</span> <span class="o">/</span> <span class="s2">&quot;output&quot;</span> <span class="o">/</span> <span class="s2">&quot;metrics.jsonl&quot;</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>        <span class="k">assert</span> <span class="n">metrics_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>        <span class="c1"># Verify metrics logged</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metrics_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>            <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="s2">&quot;step&quot;</span> <span class="ow">in</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">)</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="s2">&quot;metrics&quot;</span> <span class="ow">in</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">)</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_errors_logged_to_error_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiny_config</span><span class="p">,</span> <span class="n">temp_workspace</span><span class="p">):</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Errors during training should be logged to error file.&quot;&quot;&quot;</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>        <span class="c1"># Force an error during training</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>        <span class="c1"># ... code to trigger error ...</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>        <span class="n">error_file</span> <span class="o">=</span> <span class="n">temp_workspace</span> <span class="o">/</span> <span class="s2">&quot;test&quot;</span> <span class="o">/</span> <span class="s2">&quot;output&quot;</span> <span class="o">/</span> <span class="s2">&quot;errors.jsonl&quot;</span>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>        <span class="k">assert</span> <span class="n">error_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>        <span class="k">assert</span> <span class="s2">&quot;error_type&quot;</span> <span class="ow">in</span> <span class="n">entry</span>
<a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a>        <span class="k">assert</span> <span class="s2">&quot;traceback&quot;</span> <span class="ow">in</span> <span class="n">entry</span>
<a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a>
<a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a>    <span class="c1"># ... more integration tests</span>
</code></pre></div>
<hr />
<h2 id="success-criteria">Success Criteria<a class="headerlink" href="#success-criteria" title="Permanent link">&para;</a></h2>
<h3 id="functional-requirements">Functional Requirements<a class="headerlink" href="#functional-requirements" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] All <code>print()</code> statements replaced with appropriate logging</li>
<li>[ ] Structured logging implemented and tested</li>
<li>[ ] Metrics logging captures all training metrics</li>
<li>[ ] Error tracking captures and aggregates all errors</li>
<li>[ ] Performance logging tracks bottlenecks</li>
<li>[ ] WandB integration working</li>
<li>[ ] Log rotation implemented</li>
<li>[ ] 100% unit test coverage on logging components</li>
</ul>
<h3 id="performance-requirements">Performance Requirements<a class="headerlink" href="#performance-requirements" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Logging overhead &lt; 1% of training time</li>
<li>[ ] Log file I/O does not block training</li>
<li>[ ] Memory usage for logging &lt; 100MB</li>
</ul>
<h3 id="quality-requirements">Quality Requirements<a class="headerlink" href="#quality-requirements" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] All tests passing</li>
<li>[ ] Documentation complete</li>
<li>[ ] Code review approved</li>
<li>[ ] Integration tested with real training runs</li>
</ul>
<hr />
<h2 id="appendix-log-message-examples">Appendix: Log Message Examples<a class="headerlink" href="#appendix-log-message-examples" title="Permanent link">&para;</a></h2>
<h3 id="startup-logs">Startup Logs<a class="headerlink" href="#startup-logs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>2025-09-30 14:30:00 [INFO] model_foundry.trainer: Experiment initialized
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>  experiment: exp0_baseline
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>  git_hash: e7607e6
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>  device: cuda:0
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>  model_params: 124823296
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>2025-09-30 14:30:02 [INFO] model_foundry.data: Dataset loaded
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>  train_size: 1000000
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>  test_size: 10000
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>  columns: [&#39;input_ids&#39;, &#39;attention_mask&#39;]
</code></pre></div>
<h3 id="training-logs">Training Logs<a class="headerlink" href="#training-logs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>2025-09-30 14:30:15 [INFO] model_foundry.training.loop: Training step completed
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>  step: 100
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>  epoch: 0
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>  loss: 3.245
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>  lr: 0.0001
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>  tokens_per_sec: 8500
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>  grad_norm: 1.23
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>2025-09-30 14:30:16 [DEBUG] model_foundry.training.loop: forward_pass completed in 0.0234s
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>2025-09-30 14:30:16 [DEBUG] model_foundry.training.loop: backward_pass completed in 0.0189s
</code></pre></div>
<h3 id="error-logs">Error Logs<a class="headerlink" href="#error-logs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>2025-09-30 14:35:22 [ERROR] model_foundry.training.checkpointing: Failed to save checkpoint
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>  step: 5000
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>  error_type: IOError
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>  error_message: No space left on device
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>  checkpoint_dir: /output/checkpoint-5000
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>2025-09-30 14:36:10 [WARNING] model_foundry.training.loop: Gradient overflow detected
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>  step: 5050
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>  scaler_scale: 65536.0
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>  action: scaled_down
</code></pre></div>
<hr />
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>This comprehensive logging plan provides:</p>
<ol>
<li><strong>Structured, parseable logs</strong> for automated analysis</li>
<li><strong>Clear logging hierarchy</strong> organized by subsystem</li>
<li><strong>Comprehensive test coverage</strong> (50+ unit tests, 15+ integration tests)</li>
<li><strong>Performance tracking</strong> to identify bottlenecks</li>
<li><strong>Error aggregation</strong> for debugging production issues</li>
<li><strong>Monitoring integration</strong> with WandB and other tools</li>
<li><strong>Migration path</strong> from current print-based logging</li>
</ol>
<p>The implementation will significantly improve observability, debuggability, and maintainability of the model_foundry training framework.</p>
<hr />
<h2 id="weights-biases-wandb-integration">Weights &amp; Biases (WandB) Integration<a class="headerlink" href="#weights-biases-wandb-integration" title="Permanent link">&para;</a></h2>
<h3 id="quick-setup-guide">Quick Setup Guide<a class="headerlink" href="#quick-setup-guide" title="Permanent link">&para;</a></h3>
<p><strong>See <a href="WANDB_INTEGRATION_GUIDE.md">WANDB_INTEGRATION_GUIDE.md</a> for complete instructions.</strong></p>
<h3 id="1-create-wandb-account">1. Create WandB Account<a class="headerlink" href="#1-create-wandb-account" title="Permanent link">&para;</a></h3>
<ol>
<li>Visit <a href="https://wandb.ai/signup">https://wandb.ai/signup</a></li>
<li>Sign up (free tier available)</li>
<li>Get API key from <a href="https://wandb.ai/authorize">wandb.ai/authorize</a></li>
</ol>
<h3 id="2-configure-api-key">2. Configure API Key<a class="headerlink" href="#2-configure-api-key" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1"># Interactive login (recommended)</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>wandb<span class="w"> </span>login
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1"># Or set environment variable</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-40-character-api-key&quot;</span>
</code></pre></div>
<h3 id="3-enable-in-configuration">3. Enable in Configuration<a class="headerlink" href="#3-enable-in-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1"># config/experiment.yaml</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="nt">logging</span><span class="p">:</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">  </span><span class="nt">use_wandb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">  </span><span class="nt">wandb_project</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;model-foundry-experiments&quot;</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">  </span><span class="nt">log_metrics_every_n_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div>
<h3 id="4-run-training">4. Run Training<a class="headerlink" href="#4-run-training" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>python<span class="w"> </span>-m<span class="w"> </span>model_foundry.cli<span class="w"> </span>train<span class="w"> </span>configs/experiment.yaml
</code></pre></div>
<h3 id="what-gets-logged-to-wandb">What Gets Logged to WandB<a class="headerlink" href="#what-gets-logged-to-wandb" title="Permanent link">&para;</a></h3>
<p><strong>Metrics (every N steps):</strong>
- Training loss
- Learning rate
- Gradient norm
- Tokens per second
- GPU memory usage</p>
<p><strong>System Info:</strong>
- Git commit hash
- Configuration (all hyperparameters)
- System metrics (GPU, CPU)</p>
<p><strong>Artifacts (optional):</strong>
- Model checkpoints
- Training curves
- Evaluation results</p>
<h3 id="wandblogger-usage">WandBLogger Usage<a class="headerlink" href="#wandblogger-usage" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">model_foundry.logging_components</span><span class="w"> </span><span class="kn">import</span> <span class="n">WandBLogger</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="c1"># Initialize</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">wandb_logger</span> <span class="o">=</span> <span class="n">WandBLogger</span><span class="p">(</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;model-foundry&quot;</span><span class="p">,</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;exp0_baseline&quot;</span><span class="p">,</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt2&quot;</span><span class="p">]</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="p">)</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="c1"># Log metrics</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="n">wandb_logger</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>    <span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>    <span class="n">metrics</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>        <span class="s2">&quot;train/loss&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>        <span class="s2">&quot;train/lr&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a>        <span class="s2">&quot;train/grad_norm&quot;</span><span class="p">:</span> <span class="mf">1.23</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>    <span class="p">}</span>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="p">)</span>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="c1"># Log system metrics</span>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="n">wandb_logger</span><span class="o">.</span><span class="n">log_system_metrics</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="c1"># Watch model (log gradients/parameters)</span>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="n">wandb_logger</span><span class="o">.</span><span class="n">watch_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">log_freq</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a>
<a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="c1"># Log artifacts</span>
<a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a><span class="n">wandb_logger</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span>
<a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a>    <span class="s2">&quot;output/checkpoint-1000&quot;</span><span class="p">,</span>
<a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a>    <span class="n">artifact_type</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span>
<a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;checkpoint-1000&quot;</span>
<a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a><span class="p">)</span>
<a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a>
<a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a><span class="c1"># Finish run</span>
<a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a><span class="n">wandb_logger</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</code></pre></div>
<h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1"># Disable WandB (override config)</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_MODE</span><span class="o">=</span>disabled
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="c1"># Offline mode (sync later)</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_MODE</span><span class="o">=</span>offline
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="c1"># Silent mode (no console output)</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_SILENT</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="c1"># Custom project</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_PROJECT</span><span class="o">=</span>my-experiment
</code></pre></div>
<h3 id="viewing-results">Viewing Results<a class="headerlink" href="#viewing-results" title="Permanent link">&para;</a></h3>
<ol>
<li>Go to <a href="https://wandb.ai/home">wandb.ai/home</a></li>
<li>Click on your project</li>
<li>View runs with:</li>
<li>Real-time metric graphs</li>
<li>Configuration comparison</li>
<li>System resource monitoring</li>
<li>Artifact downloads</li>
</ol>
<h3 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h3>
<p><strong>Not logged in:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>wandb<span class="w"> </span>login<span class="w"> </span>--relogin
</code></pre></div></p>
<p><strong>Disable temporarily:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_MODE</span><span class="o">=</span>disabled
</code></pre></div></p>
<p><strong>Offline sync:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>wandb<span class="w"> </span>sync<span class="w"> </span>wandb/offline-run-*
</code></pre></div></p>
<h3 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Full Guide:</strong> <a href="WANDB_INTEGRATION_GUIDE.md">WANDB_INTEGRATION_GUIDE.md</a></li>
<li><strong>WandB Docs:</strong> <a href="https://docs.wandb.ai">docs.wandb.ai</a></li>
<li><strong>Quickstart:</strong> <a href="https://docs.wandb.ai/quickstart">docs.wandb.ai/quickstart</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>